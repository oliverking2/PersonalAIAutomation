services:
  # ----------------------------
  # Postgres (Database)
  # ----------------------------
  postgres:
    image: postgres:18-alpine
    container_name: personal_automation_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
      DAGSTER_DB_PASSWORD: ${DAGSTER_DB_PASSWORD}
      APP_DB_PASSWORD: ${APP_DB_PASSWORD}
      GLITCHTIP_DB_PASSWORD: ${GLITCHTIP_DB_PASSWORD}
    ports:
      - "${DATABASE_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./setup/postgres:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------
  # FastAPI (API)
  # ----------------------------
  api:
    build: .
    container_name: personal_automation_api
    restart: unless-stopped
    command: [
      "uvicorn",
      "src.api.app:app",
      "--host", "0.0.0.0",
      "--port", "8000"
    ]
    ports:
      - "${API_PORT}:8000"
    env_file: .env
    environment:
      - DATABASE_HOST=postgres
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ----------------------------
  # Telegram Bot (polling)
  # ----------------------------
  telegram:
    build: .
    container_name: personal_automation_telegram
    restart: unless-stopped
    command: ["python", "-m", "src.messaging.telegram"]
    env_file: .env
    environment:
      - DATABASE_HOST=postgres
      - API_HOST=api
      - API_PORT=8000
    depends_on:
      postgres:
        condition: service_healthy
      api:
        condition: service_healthy

  # ----------------------------
  # Dagster (orchestration)
  # ----------------------------
  dagster-webserver:
    build: .
    container_name: personal_automation_dagster_webserver
    restart: unless-stopped
    command: ["dagster-webserver", "-h", "0.0.0.0", "-p", "3000", "-w", "workspace.yaml"]
    ports:
      - "${DAGSTER_WEBSERVER_PORT}:3000"
    env_file: .env
    environment:
      - DAGSTER_HOME=/app
      - DAGSTER_POSTGRES_URL=postgresql://dagster:${DAGSTER_DB_PASSWORD}@postgres:5432/dagster
      - DATABASE_HOST=postgres
      - API_HOST=api
      - API_PORT=8000
    depends_on:
      postgres:
        condition: service_healthy

  dagster-daemon:
    build: .
    container_name: personal_automation_dagster_daemon
    restart: unless-stopped
    command: ["dagster-daemon", "run"]
    env_file: .env
    environment:
      - DAGSTER_HOME=/app
      - DAGSTER_POSTGRES_URL=postgresql://dagster:${DAGSTER_DB_PASSWORD}@postgres:5432/dagster
      - DATABASE_HOST=postgres
      - API_HOST=api
      - API_PORT=8000
    depends_on:
      postgres:
        condition: service_healthy

  # ----------------------------
  # GlitchTip (error tracking)
  # ----------------------------
  glitchtip:
    image: glitchtip/glitchtip:latest
    container_name: personal_automation_glitchtip
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${GLITCHTIP_PORT}:8000"
    environment:
      DATABASE_URL: "postgres://glitchtip:${GLITCHTIP_DB_PASSWORD}@postgres:5432/glitchtip"
      SECRET_KEY: ${GLITCHTIP_SECRET_KEY}
      GLITCHTIP_DOMAIN: ${GLITCHTIP_DOMAIN}
      CSRF_TRUSTED_ORIGINS: ${GLITCHTIP_DOMAIN}
      VALKEY_URL: ""

      # Minimal setup: no real email for now (emails go to container logs)
      EMAIL_URL: "consolemail://"
      DEFAULT_FROM_EMAIL: "glitchtip@local"

      # Keep it private unless you explicitly want signups
      ENABLE_OPEN_USER_REGISTRATION: "False"

      # Keep resource usage sensible
      CELERY_WORKER_CONCURRENCY: "2"
    command: ./bin/run-all-in-one.sh

volumes:
  postgres_data:
  msal_cache:
